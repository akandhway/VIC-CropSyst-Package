#include "soil/chemical_balance.h"
#include <iostream>
#include "rptoptns.h"
#include <math.h>
#ifndef compareHPP
#  include "corn/math/compare.hpp"
#endif
#include "static_phrases.h"
#include "corn/measure/measures.h"
//_____________________________________________________________________________/
Chemical_balance_accumulators::Chemical_balance_accumulators
   (float64           _original_profile_content_M
   ,std::string       &_chemical_name                                            //040931
   ,const std::string &_transformation_label                                     //040931
   ,float64        _chem_to_element_factor
   ,bool           _has_uptake)                                                  //040931
   :original_profile_content_M(_original_profile_content_M)
   ,transformed_to_M          (0)
   ,transformed_from_M        (0)
   ,applied_irrig_soil_M      (0)
   ,applied_M                 (0)
   ,balance_leached_M         (0)
   ,reported_leached_M        (0)
   ,uptake_M                  (0)
   ,residue_M                 (0)
   ,total_requirements        (0)
   ,current_profile_content_M (0)
   ,recalibration_M           (0)                                                //011115

   ,balance_error             (0)
   ,pending_infiltration                 (0)                                     //071016
   ,chemical_name          (_chemical_name)                                      //041001
   ,transformation_label   (_transformation_label)                               //041001
   ,has_uptake             (_has_uptake)                                         //041001
   ,chem_to_element_factor (_chem_to_element_factor)
{}
//__________________________________Chemical_balance_accumulators_constructor__/
float64 Chemical_balance_accumulators::balance
(float64 i_current_profile_content_M)
{
   current_profile_content_M = i_current_profile_content_M;
   balance_error =
         + original_profile_content_M
         + transformed_from_M
         + applied_irrig_soil_M
         + residue_M
         - pending_infiltration                                                  //071016
         - recalibration_M                                                       //011115
         - current_profile_content_M                                             //981006
         - transformed_to_M
         - balance_leached_M
         - uptake_M;
   float64 acceptable_error =                                                    //991205
      CORN::must_be_greater_or_equal_to<float64>
      (0.5 *         //110825  was 0.05
       (+ original_profile_content_M + transformed_from_M),0.00001);             //990311

//std::cerr << std::endl << chemical_name << " balance error:" << balance_error << std::endl;

   if (fabs(balance_error) < acceptable_error)                                   //990311
      balance_error = 0.0;                                                       //990311

/*170503  This is temporarily disabled because not accomodating new receiver idiom

if (!CORN::is_approximately<float64>(balance_error,0.0,0.01))
{
std::cerr << std::endl << chemical_name << " balance error:" << balance_error
<< " acceptable:" << acceptable_error
<< " chemical load:" << (+ original_profile_content_M + transformed_from_M)
<< std::endl;
std::cerr
<< "OPC:" << original_profile_content_M << std::endl
<< "TRf:" << transformed_from_M << std::endl
<< "app:" << applied_irrig_soil_M << std::endl
<< "res:" << residue_M << std::endl
<< "PIn:" << pending_infiltration << std::endl
<< "rec:" << recalibration_M << std::endl
<< "CPC:" << current_profile_content_M << std::endl
<< "TRt:" << transformed_to_M <<std::endl
<< "BlL:" << balance_leached_M <<std::endl
<< "upt:" << uptake_M << std::endl;
return balance_error;
}
*/
//if (chemical_name == "salt")
//cout << balance_error << endl;

   return balance_error;
}
//____________________________________________________________________balance__/
//060206 85 lines


