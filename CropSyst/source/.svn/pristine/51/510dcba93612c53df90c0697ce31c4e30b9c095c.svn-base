#include "crop/thermal_time_common.h"
#include "crop/crop_param.h"
#include "corn/math/statistical/stats.h"
#include "corn/math/compare.hpp"
#include "crop/growth_stages.h"
#include "common/weather/parameter/WP_temperature.h"
#include "CS_suite/observation/CS_inspector.h"
#include "csvc.h"
namespace CropSyst
{
//______________________________________________________________________________
Thermal_time_common::Thermal_time_common
( const Crop_parameters_struct/*_class*/::Thermal_time    &parameters_           //110218
, const Physical::Temperature                  &stress_adjusted_temperature_     //150217
, const Air_temperature_minimum                &air_temperature_min_             //150217
//181116 moved to Photoperidization , const float64                  &_ref_day_length_hours                                      //140812
, bool                                          cropsyst_fruit_model_            //041212
,Vernalization                                 *vernalization_optional           //181116
,Photoperiodization                            *photoperiodization_optional      //181116
/*181116
, const Crop_parameters_struct::Vernalization  *_vernalization_parameters
, const Crop_parameters_struct::Photoperiod    *_photoperiod_parameters
*/
)
:parameters                                                        (parameters_)
,cropsyst_fruit_model                                    (cropsyst_fruit_model_) //041212
//181116 moved ,photoperiod_parameters          (_photoperiod_parameters)
,stress_adjusted_temperature                      (stress_adjusted_temperature_) //140625
,air_temperature_min                                      (air_temperature_min_) //140625
//181116 moved ,temperature_with_est_night                        (temperature_with_est_night_) //140625
//181116 moved ,ref_day_length_hours                     (ref_day_length_hours_) //140812
,clipping_recovery_deg_days_deprecated                                       (0) //040826
//181116,vernalization                                                               (0) //111109
//181116,photoperiodization                                                          (0) //181116
,growing_degree_day                                                          (0)
,consecutive_days_no_accumulation                                            (0) //030515
, vernalization                                         (vernalization_optional) //181116
, photoperiodization                               (photoperiodization_optional) //181116
{  clear_accum_degree_days();                                                    //140619
}
//______________________________________________________________________________
void Thermal_time_common::clear_accum_degree_days()                modification_
{
   #if (!PHENOLOGY_VERSION || (PHENOLOGY_VERSION==2013))
   for (int i = 0; i <= 1; i++)                                                  //140619
   {  accum_degree_days_normal [i] = 0.0;                                        //140619
      accum_degree_days_clipped[i] = 0.0;                                        //140619
   }
   #endif
   #if ((PHENOLOGY_VERSION==2018))
   GDDs = 0;                                                                     //181114
   #endif
   clipping_recovery_deg_days_deprecated = 0.0;                                  //040826
   consecutive_days_no_accumulation = 0;                                         //030515
}
//______________________________________________________________________________

float64  Thermal_time_common::Vernalization::update()             rectification_
{  Vfactor =1.0;
   float64 temperature = temperature_with_est_night.Celcius();                   //181116
   float64 temp_low   = parameters.low_temp;                                     //020628
   float64 temp_high  = parameters.high_temp;                                    //020628
   float64 vern_start = parameters.start;                                        //020628
   float64 vern_end   = parameters.end;                                          //020628
   float64 min_factor = parameters.min_factor;                                   //160712
   float64 vern_day = (temperature > temp_high)
   ? (1.0 - (temperature - temp_high) / 7.0)
   : (temperature < temp_low)
      ? (1.0 - (temp_low - temperature) / 7.0)
      : 1.0;
   if (vern_day < 0.0)  vern_day = 0.0;
   vern_days += vern_day;
   if (vern_days >= vern_start)                                                  //160713
   {  Vfactor =
         min_factor + ( (1.0 - min_factor) *                                     //160712
           (vern_days - vern_start) / (vern_end - vern_start));
      if (status != VERNALIZATION_ACTIVE)
      {   // output vernalization starts to log was here
          status  = VERNALIZATION_START;                                         //020628
      }
   }
   if ((vern_days >= vern_end) && (status == VERNALIZATION_ACTIVE))
   {  Vfactor = 1.0;
      vern_days = 0.0;                                                           //021204
      status = VERNALIZATION_END;                                                //020628
   }
   Vfactor = CORN::must_be_between<float64>(Vfactor,0.0,1.0);                    //181116
   return Vfactor;
}
//_1997?________________________________________________________________________
Thermal_time_common::Photoperiodization::Photoperiodization
(const Crop_parameters_struct::Photoperiod &photoperiod_parameters_
,const float64                             &ref_day_length_hours_)
: photoperiod_parameters                               (photoperiod_parameters_)
, ref_day_length_hours                                   (ref_day_length_hours_)
, factor                                                                   (1.0)
{}
//_Photoperiodization::constructor__________________________________2018-11-18_/
//181116 float64 Thermal_time_common::calc_photoperiod_factor()              calculation_
float64 Thermal_time_common::Photoperiodization::update()         rectification_
{
   factor =1.0;  // 1 has no effect
   //181116 float64 Pfactor =1.0;  // 1 has no effect
   //181116 if (photoperiod_parameters)
   //181116 {
   float64 stop_day_length          = photoperiod_parameters.stop_day_length;   // 0-24 hours
   float64 unconstrained_day_length = photoperiod_parameters.unconstrained_day_length; // 0-24 hours
   if (stop_day_length == unconstrained_day_length)
      return 1.0;     // Note: U = S not allowed
/*
Short-day crops
Daylength above which development towards flowering stops (hours)								14
Daylength below which development towards flowering is not constrained (hours)								10

Long-day crops
Daylength below which development towards flowering stops (hours)								10
Daylength above which development towards flowering is not constrained (hours)								14
*/
   float64 day_length_hours = ref_day_length_hours;                              //140812
   factor =
            (unconstrained_day_length >= stop_day_length)
            ?  // Long-day crop
               (day_length_hours <= stop_day_length)
               ? 0.0
               : day_length_hours >= unconstrained_day_length
                  ? 1.0
                  : 1.0 - ((day_length_hours - unconstrained_day_length)
                          /(stop_day_length  - unconstrained_day_length))
            :  // Short-day crop
               (day_length_hours >= stop_day_length)
               ? 0.0
               : (day_length_hours <= unconstrained_day_length)
                  ? 1.0
                  : 1.0 - ((day_length_hours - unconstrained_day_length )
                          /(stop_day_length - unconstrained_day_length));
  //181116 }
  factor = CORN::must_be_between<float64>(factor,0.0,1.0);                       //181116
  return factor;
}
//_update_factor____________________________________________________2018-11-16_/
float64 Thermal_time_common::calc_growing_degree_day_hourly_resolution
( const CORN::Dynamic_array<float32> &stress_adj_hourly_temperature)calculation_
{  // Adapted from Environmental BioPhysics (Gaylon Campbell)
   Statistical_running_tally hourly_thermal_time; // deg hours
   for (int hr = 0; hr < 24; hr++)
   {
      float64  plant_temperature = stress_adj_hourly_temperature.get(hr);        //030610
      const Crop_parameters_struct::Thermal_time::Temperature &temperature
         = parameters.temperature;                   //181111
      float64  thermal_time =   // Degree hours ?                                //130415
         (  (plant_temperature <= temperature.base/*181111 parameters.base_temperature*/)   //130415
          ||(plant_temperature >= temperature.max /*181111 parameters.max_temperature*/))   //130415
         ? 0.0                                                                   //130415
         : (plant_temperature <= temperature.opt/*181111 parameters.opt_temperature*/ )                     //130415
            ? (plant_temperature - parameters.temperature.base/*181111 base_temperature*/)
            :  (temperature.opt/*181111 parameters.opt_temperature*/ - temperature.base/*181111 parameters.base_temperature*/) *      //130415
               (1.0 - ( (plant_temperature - temperature.opt /*181111 parameters.opt_temperature*/)         //130415
                /(temperature.max/*181111 parameters.max_temperature*/ - temperature.opt/*181111 parameters.opt_temperature*/)));    //130415
      thermal_time = CORN::must_be_0_or_greater<float64>(thermal_time);
      hourly_thermal_time.append(thermal_time);
   }
   // Warning we need to do senescence reduction etc...!!!
   float64 result_growing_degree_day = hourly_thermal_time.get_mean();
   return result_growing_degree_day;
}
//_2002-11-24___________________________________________________________________
float64 Thermal_time_common::calc_limited_growing_degree_day
(float64 growing_deg_day
// 181116 Now member ,float64 vernalization_factor
#if (!PHENOLOGY_VERSION || (PHENOLOGY_VERSION==2013))
,Normal_crop_event_sequence  growth_stage_sequence                               //130902
#endif
)                                       calculation_
{
   float64 limit_factor = 1.0;

   #if (!PHENOLOGY_VERSION || (PHENOLOGY_VERSION==2013))
   float64 vernalization_factor = vernalization       ? vernalization->update() : 1.0;
   float64 photofactor          = photoperiodization  ? photoperiodization->update() : 1.0;
   #endif
   #if ((PHENOLOGY_VERSION==2018))
   float64 vernalization_factor = vernalization       ? vernalization->update() : 1.0;
   float64 photofactor          = photoperiodization  ? photoperiodization->update() : 1.0;
   #endif


//   #if ((PHENOLOGY_VERSION==2018))
//   if (limited)
//   #endif
   {
   /*181116 moved
   float64 photofactor =
      photoperiod_parameters                                                     //020505
      ? calc_photoperiod_factor()                                                //140812
      : 1.0;
   photofactor = CORN::must_be_between<float64>(photofactor,0.0,1.0);            //160712
   */
   //181116 moved vernalization_factor = CORN::must_be_between<float64>(vernalization_factor,0.0,1.0);          //160712
   /*181111 float64*/ limit_factor = std::min<float64>(photofactor,vernalization_factor);
   #if (!PHENOLOGY_VERSION || (PHENOLOGY_VERSION==2013))
   if ((growth_stage_sequence == NGS_GERMINATION)                                //130902
   ||  (growth_stage_sequence >  NGS_ANTHESIS))      limit_factor = 1.0;         //130902_041213
   #endif
   // in PHENOLOGY_2018 only specific periods will have vernalization or photoperiod.
   }
   float64 limited_growing_degree_day =  growing_deg_day * limit_factor;
   return  limited_growing_degree_day;
}
//_2000-03-30___________________________________________________________________
double Thermal_time_common::accumulate_degree_days
(
//181116 never used Dynamic_array<float32> *stress_adj_hourly_temperature ,      //071127
#if (!PHENOLOGY_VERSION || (PHENOLOGY_VERSION==2013))
 Normal_crop_event_sequence growth_stage_sequence                                //130911
#endif
)
{  float64 vernalization_factor = 1.0;                                           //111109
   if (vernalization)                                                            //111109
   {  vernalization_factor = vernalization->update(); //181116 update_factor()   //181116
         //181116 now member ref (temperature_with_est_night.Celcius());         //150122_111109
      if (vernalization->is_satisfied())                                         //111109
      {
         #if (!PHENOLOGY_VERSION || (PHENOLOGY_VERSION==2013))
         delete vernalization;
         #endif
         vernalization = 0;                                                      //111109
      }
   }
   growing_degree_day =                                                          //010723
     calc_growing_degree_day_daily_resolution                                    //021125
     (stress_adjusted_temperature.Celcius()                                      //140625
     ,air_temperature_min.Celcius());                                            //140625_021125
/*
if (growing_degree_day > 0.000001)
std::clog << "reached GDD" << std::endl;
*/
   float64 limited_grow_deg_day = calc_limited_growing_degree_day                //010723
      (growing_degree_day
      //181116 now member ,vernalization_factor
      #if (!PHENOLOGY_VERSION || (PHENOLOGY_VERSION==2013))
      , growth_stage_sequence
      #endif
      /*181116
      #if ((PHENOLOGY_VERSION==2018))
      ,limited
      #endif
      */
      );                             //130911
      //not sure if this is correct, it wasn't set up right, need to check if we still want to do this
   if (clipping_recovery_deg_days_deprecated > 0.0)                                         //040826
   {
      #if (!PHENOLOGY_VERSION || (PHENOLOGY_VERSION==2013))
      accum_degree_days_normal[TT_TODAY]
      #endif
      #if ((PHENOLOGY_VERSION==2018))
      GDDs
      #endif
         += 0.001;                               //040826
         // Only slight accumulation to prevent any consecutive days of no accumulation problems
      /*181114 does nothing
      if  (clipping_recovery_deg_days < 0.0) clipping_recovery_deg_days = 0.0;   //040826
         // Shouldn't be necessary, but just to keep it clean;
      else
      */
         clipping_recovery_deg_days_deprecated -= limited_grow_deg_day;          //040826
         // I think use limited_grow_deg_day
   } else                                                                        //040826
   #if (!PHENOLOGY_VERSION || (PHENOLOGY_VERSION==2013))
      accum_degree_days_normal[TT_TODAY] += limited_grow_deg_day;
   accum_degree_days_clipped[TT_TODAY] += limited_grow_deg_day;                  //040830
   #endif
   #if ((PHENOLOGY_VERSION==2018))
      GDDs += limited_grow_deg_day;                                              //181114
   #endif
   if (                                                                          //041213
   //041213_         Claudio says now use this only for the fruit model.
   //050720 decided not to do this:
       cropsyst_fruit_model &&   // Claudio decided again to restore this only for fruit, may need to eliminate it completely  //050816
     CORN::is_approximately<float64>(growing_degree_day,0.0,0.001))
   {  // If there are a number of consecutive days of no thermal time accum,     //030515
      // then we throw away the accumulation (happens during winter).            //030515
      consecutive_days_no_accumulation +=1;                                      //030515
      if (consecutive_days_no_accumulation == 10)                                //030515
      {  clear_accum_degree_days();                                              //030515
         consecutive_days_no_accumulation = 0;                                   //030515
      }
   } else                                                                        //030515
   {   consecutive_days_no_accumulation = 0; }                                   //030523
   return growing_degree_day;                                                    //010727
}
//______________________________________________________________________________
void Thermal_time_common::respond_to_clipping
(float64 new_thermal_time)                                         modification_
{
#ifdef disabled
this may be too long a period
clipping_recovery_deg_days_deprecated = 1.5 * new_thermal_time ;
#else
clipping_recovery_deg_days_deprecated = 0.0;
#endif
#if (!PHENOLOGY_VERSION || (PHENOLOGY_VERSION==2013))
   accum_degree_days_clipped[TT_TODAY] = new_thermal_time;
#endif
}
//_2004-08-23___________________________________________________________________
void Thermal_time_common::reset_to(float64 new_thermal_time)
{
   #if (!PHENOLOGY_VERSION || (PHENOLOGY_VERSION==2013))
   accum_degree_days_clipped[TT_TODAY] = new_thermal_time ;
   #endif
   #if ((PHENOLOGY_VERSION==2018))
   GDDs = new_thermal_time;
   #endif
}
//_2004-07-19___________________________________________________________________
float64 Thermal_time_common::get_accum_degree_days
(bool adjusted_for_clipping
,bool for_yesterday)
const
{  return
   #if (!PHENOLOGY_VERSION || (PHENOLOGY_VERSION==2013))
      adjusted_for_clipping
      ? accum_degree_days_clipped[for_yesterday]
      : accum_degree_days_normal [for_yesterday];
   #endif
   #if ((PHENOLOGY_VERSION==2018))
   GDDs;
   #endif
}
//______________________________________________________________________________
Thermal_time_common::Vernalization::Vernalization
(const CropSyst::Crop_parameters_struct::Vernalization              &parameters_
,const Physical::Temperature                        &temperature_with_est_night_
)
:parameters                                                        (parameters_)
,temperature_with_est_night                        (temperature_with_est_night_)
,status                                                 (VERNALIZATION_INACTIVE)
,vern_days                                                                   (0)
,Vfactor                                                                   (1.0)
{}
//_2011-11-09___________________________________________________________________
/*181116 vernalization and photoperiod are not passed to constructor
bool Thermal_time_common::enable_vernalization
(const CropSyst::Crop_parameters_struct::Vernalization &vernalization_parameters)
modification_
{  vernalization = new Vernalization(vernalization_parameters);
   return true;                                                                  //120804
}
//_2011-11-09___________________________________________________________________
*/
bool Thermal_time_common::end_day()                                modification_
{
   #if (!PHENOLOGY_VERSION || (PHENOLOGY_VERSION==2013))
   //181114 yesterdays' value was only used to match thermal time,
   accum_degree_days_normal [TT_YESTERDAY]= accum_degree_days_normal [TT_TODAY];
   accum_degree_days_clipped[TT_YESTERDAY]= accum_degree_days_clipped[TT_TODAY]; //040823
   #endif
   // PHENOLOGY_2018
   // consecutive days of no accumulation should not be a problem in 2018 version
   // because new periods are instanciated.

   return true;
}
//_2014-06-19___________________________________________________________________
RENDER_INSPECTORS_DEFINITION(Thermal_time_common)
{
   // uses crop emenator
   #if (!PHENOLOGY_VERSION || (PHENOLOGY_VERSION==2013))
   inspectors.append(new CS::Inspector_scalar(accum_degree_days_clipped[0]  ,UC_Celcius_degree_days ,*context, "growing_degree_days/clipped",sum_statistic,CSVP_crop_base_growing_degree_days));
   inspectors.append(new CS::Inspector_scalar(accum_degree_days_normal[0]   ,UC_Celcius_degree_days ,*context, "growing_degree_days/normal" ,sum_statistic,CSVP_crop_base_seasonal_thermal_time));
   #endif
   #if ((PHENOLOGY_VERSION==2018))
   inspectors.append(new CS::Inspector_scalar(GDDs   ,UC_Celcius_degree_days ,*context, "growing_degree_days/normal" ,sum_statistic,CSVP_crop_base_seasonal_thermal_time));
   #endif
   return 0;
}
//_2013-09-09__________________________________________________________________/
} // namespace CropSyst


/*

Magnitude
Consequence
Significance
Weight

Scale
proportion
range
rate
ratio


scendence
ascendence
descendence


crescendo
decrescendo



curve shapes
linear up (ascending)
linear down (descending
trapazoid

(triangle)
nonlinear   (sinusoildal?)
*/
