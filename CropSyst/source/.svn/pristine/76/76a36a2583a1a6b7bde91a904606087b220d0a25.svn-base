#include "crop/crop_root_V5.h"
#include "crop/thermal_time.h"
#include "soil/soil_I.h"

namespace CropSyst {
//______________________________________________________________________________
Crop_root_vital_V5::Crop_root_vital_V5
(const Crop_parameters_struct::Root      &parameters_
,const Phenology::Period                 &root_growth_period_                    //181107
,const Soil::Layers_interface &soil_layers_
,float32                                  initial_root_length_)
: Crop_root_vital
   (parameters_
   ,root_growth_period_                                                          //181108
   ,soil_layers_,initial_root_length_)
, above_ground_biomass(0)
{  biomass = 0.00001;
   // this is just to prevent a div 0 on the first day
}
//_constructor:Crop_root_vital_V5___________________________________2013-06-24_/
float64 Crop_root_vital_V5::calc_biomass
(float64 *output_root_biomass_by_layer)                             calculation_
{  // if root_biomass_by_layer array is passed, record the root biomass values by layer
   float64 root_shoot_ratio = parameters.root_shoot_full_ratio;
/*191121
   #if (!PHENOLOGY_VERSION || (PHENOLOGY_VERSION==2013))
      // value for when root has reached culmination
   float64 accum_thermal_time = thermal_time.get__accum_degree_days(false);
   bool root_growth_period_has_expired =  accum_thermal_time > phenology_parameters.culmination_V4.root_elongation;
   if (!root_growth_period_has_expired)
   {  // We haven't reach culmination yet
      float64 param_culmination_GDDs      = phenology_parameters.culmination_V4.root_elongation;
      float64 param_initiation_emergence  = phenology_parameters.initiation.emergence;
      float64 remaining_GDDs = (param_culmination_GDDs - accum_thermal_time);
      float64 elongation_duration_GDDs = (param_culmination_GDDs - param_initiation_emergence);
      float64 relative_GDDs_remaining = remaining_GDDs / elongation_duration_GDDs;
      root_shoot_ratio =
         parameters.root_shoot_full_ratio +
         (parameters.root_shoot_emergence_ratio - parameters.root_shoot_full_ratio)
            *  pow(relative_GDDs_remaining , 3.0);
   }
   #endif
*/
   if (!root_growth_period.has_expired())
   {
      float64 relative_GDDs_remaining = root_growth_period
         .get_thermal_time_relative_remaining();                                 //200204
         //200304 .calc_relative_thermal_time_remaining();
      root_shoot_ratio =
         parameters.root_shoot_full_ratio +
         (parameters.root_shoot_emergence_ratio - parameters.root_shoot_full_ratio)
            *  pow(relative_GDDs_remaining , 3.0);
   }
   float64 calced_root_biomass = above_ground_biomass * root_shoot_ratio;
   calced_root_biomass = std::max<float64>(calced_root_biomass,biomass);
   if (output_root_biomass_by_layer)
      for (nat8 lyr = rooting_layer; (lyr <= soil_layers.count()); lyr++)
      {  float64 root_biomass_lyr = total_fract_root_length[lyr] * calced_root_biomass;
         output_root_biomass_by_layer[lyr] = root_biomass_lyr;
      }
   return calced_root_biomass;
}
//_calc_biomass_____________________________________________________2006-06-12_/
}//_namespace CropSyst_________________________________________________________/

