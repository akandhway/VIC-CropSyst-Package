#include "CS_suite/application/CS_arguments.h"
#include "common/simulation/scenario.h"
#include "corn/data_source/vv_file.h"
#include "corn/OS/file_system_engine.h"
#include "corn/math/statistical/statistics_types.h"
#include "corn/seclusion.h"
#include <string.h>
namespace CS
{
//______________________________________________________________________________
Arguments::Arguments
(modifiable_ CS::Identification   &ID_
,const wchar_t *scenario_extension_)                                                //200525
: CORN::Arguments                                                             () //160826
, ID                                                                       (ID_) //160222
, scenario_directory_name                                                    (0)
, scenario_file_name_deprecated                                              (0)
, find_and_reset_missing_parameter_file_names                            (false) //170629
, desired_tally_statistics                 (STAT_BASIC_ELEMENTS_INIT_FINAL_bits) //170413
 #if ((CS_VERSION>=4) && (CS_VERSION<6))
, scenario_extension                                       (scenario_extension_) //200525
, V4_format_filename                                                         (0) //200525
 #endif
{
   //160222 moved for (int a = 0; a < 1000; a++) arg_recognized[a] = 0;
   // By default the CWD is assumed to be the scenario directory
   // If any directory name is specified on the command line
   // that will be assumed to be the scenario directory
     // When no command line arguments then use CWD as default scenario directory

   quiet = true;                                                                 //191104
}
//_Arguments:constructor____________________________________________2015-04-15_/
bool Arguments::get_end()
{  bool ended = CORN::Arguments::get_end();
   // Specifying the scenario directory name on the command line is deprecated
   // it should be simply the current working directory

   #if ((CS_VERSION>=4) && (CS_VERSION<6))
   V4_format_filename
      = dynamic_cast<CORN::OS::Directory_entry_name *>
      (discover_one
       (CORN::Inclusion("*.FMT",true)
       ,CORN::OS::file_entry
       ,CORN::OS::File_system::superdirectory_recursion_inclusive));
   #endif

   CORN::OS::Directory_name_concrete *arg_scenario_directory_name_optional =
      dynamic_cast<CORN::OS::Directory_name_concrete *>(discover_one
         (CORN::Inclusion("*",true)
         ,CORN::OS::directory_entry));
   if (arg_scenario_directory_name_optional)
   {  delete scenario_directory_name; // overriding default (CWD)
      scenario_directory_name = arg_scenario_directory_name_optional;
   }
   // Specifying the scenario directory name on the command line is deprecated
   // it should be simply the current working directory
   // because now there may be multiple the scenario file name discovered
   std::wstring scenario_pattern (L"*.");
   scenario_pattern.append(scenario_extension);                                  //200525
      //200525 (get_scenario_filename_extension_wstr());
   CORN::OS::File_name *arg_scenario_filename_optional =
      dynamic_cast<CORN::OS::Directory_name *>(discover_one
         (CORN::Inclusion("*",true)
         ,CORN::OS::file_entry));
   if (arg_scenario_filename_optional)
   {
      scenario_file_name_deprecated = arg_scenario_filename_optional;
      delete scenario_directory_name;
      scenario_directory_name = new CORN::OS::Directory_name_concrete
               (scenario_file_name_deprecated->get_path_directory_name()->c_str()
               ,CORN::OS::directory_entry);
   }
   return ended;
}
//_get_end__________________________________________________________2019-11-04_/
Arguments::~Arguments()
{
   delete scenario_directory_name;        //not needed scenario_directory_name = 0;
   delete scenario_file_name_deprecated;  //not needed scenario_file_name_deprecated = 0;
}
//_Arguments:destructor_____________________________________________2015-04-15_/
const CORN::OS::Directory_name &Arguments::provide_scenario_directory_name() provision_
{  if (!scenario_directory_name)
   {  if (scenario_file_name_deprecated)
      {  const CORN::OS::Directory_name *scenario_file_path = scenario_file_name_deprecated->get_path_directory_name();
         if (scenario_file_path) // The scenario file is qualified
            scenario_directory_name = new CORN::OS::Directory_name_concrete(*scenario_file_path,CORN::OS::directory_entry); //161028
      } else
      // provide_scenario_file_name may identify the scenario directory if given the scenario filename
      if (!scenario_directory_name)
         // we still dont have the scenario directory name assume CWD
         scenario_directory_name = new CORN::OS::Directory_name_concrete(/*NYI CORN::OS::directory_entry*/); //161028
   }
   return *scenario_directory_name;
}
//_provide_scenario_directory_name__________________________________2015-04-15_/
const CORN::OS::File_name &Arguments::provide_scenario_file_name()     provision_
{  if (!scenario_file_name_deprecated)
   { // scenario file was not specified on the command line search update the directory tree
      scenario_file_name_deprecated = dynamic_cast<CORN::OS::File_name_concrete*>
         (CORN::OS::file_system_engine.find_qualified_name_in_path
         (scenario_extension.c_str()                                             //20025
         //200525 get_scenario_filename_extension_wstr()
         ,provide_scenario_directory_name()));
   // Now we search for the scenario file in the scenario directory
   // or any parent directory (this is used for GIS and/or
   // other multiple runs where the template scenarios may be in a parent
   // directory. 140210
      if (!scenario_file_name_deprecated)                                        //160120
         scenario_file_name_deprecated = new CORN::OS::File_name_concrete
            (provide_scenario_directory_name()
            //200525 ,get_scenario_filename_extension_wstr()
            ,scenario_extension);                                                //200525
   }
   return *scenario_file_name_deprecated;
}
//_provide_scenario_file_name_______________________________________2015-04-15_/
bool Arguments::invalidate_scenario_directory()                    modification_
{
   delete scenario_directory_name;        scenario_directory_name = 0;
   delete scenario_file_name_deprecated;  scenario_file_name_deprecated = 0;
   return true;
}
//_invalidate_scenario_directory____________________________________2016-01-14_/
bool Arguments::is_scenario_file_named_or_found()                   affirmation_
{  provide_scenario_file_name();
   return CORN::OS::file_system_engine.exists(*scenario_file_name_deprecated);
}
//_is_scenario_file_named_or_found__________________________________2015-04-15_/
const CS::Identification &Arguments::ref_ID()                              const
{  return ID;                                                                    //160222
}
//_ref_ID___________________________________________________________2015-10-28_/
}//_namespace_CS_______________________________________________________________/

